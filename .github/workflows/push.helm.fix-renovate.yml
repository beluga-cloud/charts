---
name: Fix Renovate upgrade (helm)
on:  # yamllint disable-line rule:truthy
  push:
    branches:
      - renovate/**
    paths:
      # NOTE: only few changes should trigger this pipeline
      - charts/*/Chart.lock
      - charts/*/Chart.yaml
      - charts/*/values.yaml

concurrency:
  group: ${{ github.ref }}/helm-fix-renovate
  cancel-in-progress: true

env:
  ASDF_DIR: /home/runner/.asdf
  HELM_CONFIG_HOME: ${{ github.workspace }}/test/e2e/~helm

jobs:
  list-changed-charts:
    name: List all new/updated charts
    if: github.event.commits[0].author.name == 'renovate[bot]'
    permissions:
      contents: read
    uses: ./.github/workflows/_.helm.list-changed.yaml

  update-chart:
    name: Bump Helm version (${{ matrix.chart }})
    if: needs.list-changed-charts.outputs.charts != '[]'
    needs: [ list-changed-charts ]
    permissions: {}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        chart: ${{ fromJSON(needs.list-changed-charts.outputs.charts) }}
    concurrency:
      group: ${{ github.ref }}/helm-fix-renovate/update-chart
    steps:
      - uses: tibdex/github-app-token@32691ba7c9e7063bd457bd8f2a5703138591fa58 # v1.9.0
        id: app_auth
        with:
          app_id: ${{ secrets.BOT_ID }}
          private_key: ${{ secrets.BOT_PKEY }}
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4.1.0
        with:
          fetch-depth: 0
          token: ${{ steps.app_auth.outputs.token }}

      - uses: actions/cache/restore@704facf57e6136b1bc63b828d79edcd491f0ee84 # v3.3.2
        id: restore-asdf
        with:
          path: ${{ env.ASDF_DIR }}
          key: asdf-vm-${{ hashFiles('.tool-versions') }}
      - uses: asdf-vm/actions/install@6a442392015fbbdd8b48696d41e0051b2698b2e4 # v2.2.0
        with:
          skip_install: ${{ steps.restore-asdf.outputs.cache-hit == 'true' }}

      - name: Configure git user
        run: |
          git config user.name "Belug Apps"
          git config user.email "116495032+belug-cloud[bot]@users.noreply.github.com"

      - name: Bump the Chart version
        run: just renovate-update-chart
        working-directory: ${{ github.workspace }}/${{ matrix.chart }}
      - name: Build helm dependencies
        run: helm dependencies build
        working-directory: ${{ github.workspace }}/${{ matrix.chart }}
      - name: Build out the charts/ directory with all depending files
        run: just build-external
        working-directory: ${{ github.workspace }}/${{ matrix.chart }}

      - name: Commit and push all changes on the current PR
        continue-on-error: true
        run: |
          APP_NAME=$(cut -d/ -f2 <<<"${{ matrix.chart }}")
          git add .
          git commit --message ":package: (apps/${APP_NAME}): update and rebuild all packaging files"
          git push
