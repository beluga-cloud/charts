---
name: Ent-to-end Test (Helm)
on: # yamllint disable-line rule:truthy
  schedule:
    - cron: 0 2 * * 1,3

env:
  HELM_CONFIG_HOME: ${{ github.workspace }}/e2e/~helm
  ASDF_DIR: /var/run/asdf-vm

jobs:
  # Test all charts using the official chart-testing CLI.
  chart_testing:
    name: Test all charts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8f4b7f84864484a7bf31766abe9204da3cbe65b3 # v3.5.0
        with:
          fetch-depth: 0

      - uses: actions/cache@88522ab9f39a2ea568f7027eddc7d8d8bc9d59c8 # v3.3.1
        with:
          path: ${{ env.ASDF_DIR }}
          key: asdf-vm
      - uses: asdf-vm/actions/install@707e84f3ee349548310aeabdad0dd3bfcb9b69fa # v1.1.0

      - uses: actions/setup-python@d27e3f3d7c64b4bbf8e4abfb9b63b83e846e0435 # v4.5.0
        with:
          python-version: '3.9'
          check-latest: true
      - uses: helm/chart-testing-action@e8788873172cb653a90ca2e819d79d65a66d4e76 # v2.4.0
      - uses: helm/kind-action@d8ccf8fb623ce1bb360ae2f45f323d9d5c5e9f00 # v1.5.0
        with:
          cluster_name: kind
          wait: 30s

      - name: Prepare `kind` cluster
        run: just e2e-prepare
      - name: Run chart-testing (install)
        run: ct install --all
